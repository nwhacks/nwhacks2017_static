'use strict';const categories=['applied','accepted','waitlisted','rejected'];Object.freeze(categories);const responseCategories=['no response','going','not going','need reimbursement'];Object.freeze(responseCategories),Polymer({is:'select-hackers',properties:{hackers:{type:Array,value:[]},incr:{type:Number,value:0},categories:{type:Array,value:categories},filters:{type:Object,value:function(){return{search:'',status:'',response:'',missing_passport:!1}}},responseCategories:{type:Array,value:responseCategories}},refresh:function(){this.incr++},attached:function(){var d=this;setTimeout(function(){d.resize()},100),window.addEventListener('resize',function(){d.resize()})},resize:function(){var d=this.$.list.getBoundingClientRect().top;this.$.list.style.height=window.innerHeight-d+'px'},observers:['refresh(filters.status)','refresh(filters.checked_in)','refresh(filters.response)','refresh(filters.search)','refresh(filters.mentor)','refresh(filters.first)','refresh(filters.reimbursement)','refresh(filters.missing_passport)','handleRegistrations(registrations)','handleRegistrations(registrations.*)','handlePartials(registrations.*)','filter(hackers, filters, incr, hackers.*)'],cleanEmail:function(d){return d.toLowerCase().trim()},handleRegistrations:function(){this.lastRender&&clearTimeout(this.lastRender),this.lastRender=setTimeout(this.handleRegistrationsInternal.bind(this),300)},handlePartials:function(d){const f=d.path;if(this.hasPrefix(f,'registrations.#')){const g=f.split('.'),j=g.slice(0,2).join('.'),k=this.get(j),l=k.filteredIndex;if(this.filtered[l]===k){const m='filtered.#'+l+'.'+g.slice(2).join('.');console.log(m),this.notifyPath(m)}}},hasPrefix:function(d,f){return d.slice(0,f.length)==f},handleRegistrationsInternal:function(){console.log('rendering!');const d=this.registrations.map(g=>{return g.id=g.$key,g});d.sort(function(g,j){return g.id<j.id?-1:1});var f={};d.forEach((g,j)=>{g.index=j;const k=this.cleanEmail(g.email);g.cleanEmail=k;const{count:l}=f[k]||{count:0};f[k]={last:g.id,count:l+1}}),d.forEach(g=>{const{last:k,count:l}=f[g.cleanEmail];1<l&&k!==g.id&&(g.duplicate=!0)}),d.forEach(g=>{const j=this.cleanEmail(g.school);(0<=j.indexOf('secondary')||0<=j.indexOf('high'))&&(g.hs=!0),g.status?-1==categories.indexOf(g.status)&&(g.status=categories[g.status]):g.status='applied'}),this.updateEmailIndex(d),this.clusters=this.clusterTeams(d),this.updateLunrIndex(d),console.log('hackers update'),this.hackers=d},clusterTeams:function(d){const f={};return d.forEach(g=>{if(!g.duplicate&&g.teammates&&0!==g.teammates.trim().length){const j=g.teammates.split(',').map(k=>this.cleanEmail(k));j.forEach(k=>{this.emailIndex[k]&&this.addPersonToCluster(f,g.cleanEmail,k)})}}),f},addPersonToCluster:function(d,f,g){const j=d[f]||new Set,k=d[g];j.add(f),j.add(g),k&&j!==k&&k.forEach(l=>{j.add(l),d[l]=j}),d[f]=j,d[g]=j},updateEmailIndex:function(d){const f={};d.forEach(g=>{g.duplicate||(f[g.cleanEmail]=g)}),this.emailIndex=f},updateLunrIndex:function(d){if(this.lastLunrIndexCount!==d.length){this.lastLunrIndexCount=d.length;const f=lunr(function(){this.ref('index'),this.field('id'),this.field('city'),this.field('email'),this.field('emailSplit'),this.field('github'),this.field('personalsite'),this.field('linkedin'),this.field('name'),this.field('reason'),this.field('school'),this.field('teammates')});d.forEach(function(g){g.emailSplit=g.email.replace(/@/g,' '),f.add(g)}),this.lunr=f}},responseCat:function(d){return this.responseCategories[d]},eq:function(d,f){return d==f},export:function(){const d=JSON.parse(JSON.stringify(this.filtered));d.forEach(g=>{g.resume=this.resumeLink(g.resume)});var f=new CSV(d,{header:!0}).encode();this.downloadFile('applicants_export.csv',f)},downloadFile:function(d,f){var g=new Blob([f]);const j=document.createElement('a');j.setAttribute('download',d),j.setAttribute('href',URL.createObjectURL(g)),document.body.appendChild(j),j.click()},title:function(d){return d.name+' ('+d.email+')'},filter:function(d,f){var j=d;if(this.totalCount=d.length,3<=f.search.length){var k=this.lunr.search(f.search);j=k.map(function(q){return d[q.ref]})}var l=f.status,m=f.response,n=this.responded(m),o=j.filter(q=>{var t=(''===l||'null'===l||'All'===l||l===q.status)&&(''===m||'null'===m||'All'===m||this.respondedWith(q,n))&&!q.duplicate;return f.mentor&&(t=t&&q.mentor),f.checked_in&&(t=t&&q.checked_in),f.reimbursement&&(t=t&&q.travel_reimbursement),f.first&&(t=t&&q.first_hackathon),f.missing_passport&&(t=t&&q.rsvp&&'No'===q.rsvp.passport),t});o.forEach((q,r)=>{q.filteredIndex=r});const p=this.$.list.scrollTop;this.filtered=o,this.filteredCount=o.length,this.$.list.scroll(0,p)},resumeLink:function(d){return'https://firebasestorage.googleapis.com/v0/b/nwhacks-96701.appspot.com/o/'+encodeURIComponent(d)+'?alt=media'},githubLink:function(d){return d?0<d.indexOf('github.com')?d:'https://github.com/'+d:void 0},linkedinLink:function(d){return d?0<d.indexOf('linkedin.com')?d:'https://linkedin.com/in/'+d:void 0},selected:function(d){var f=categories.indexOf(d);return 0<=f?f:0},responded:function(d){var f=responseCategories.indexOf(d);return 0<=f?f:0},eq:function(d,f){return d===f},respondedWith:function(d,f){return d.acceptance_sent&&'accepted'===d.status&&(d.rsvp?1:0)===f},onSelect:function(d){const f=d.target.value,g=d.model.hacker;this.setHackerStatus(g,f)},onSelectTeam:function(d){const f=d.target.value;d.target.value='';const g=d.model.hacker,j=this.teammates(g);j.forEach(k=>{const l=this.emailIndex[k];this.setHackerStatus(l,f)})},setHackerStatus:function(d,f){return-1===categories.indexOf(f)?void console.log('ignoring status:',f):void(d.status!==f&&(this.set('filtered.'+d.filteredIndex+'.status',f),this.patchHacker(d)))},phoneChange:function(d){var f=d.model.hacker;this.patchHacker(f)},checkIn:function(d){var f=d.model.hacker;this.patchHacker(f)},patchHacker:function(d){delete d.$key,this.$.regs.setStoredValue('/registrations/'+d.id,d);this.hackers},refreshList:function(){this.incr++},handleErr:function(d,f){this.handleError(d,f.error)},hackerAdminURL:function(d){return'/api/admin/nwhacks/registration/'+d.id+'/change/'},handleError:function(d,f){console.log('Error',f),this.error=f,this.$.error.open()},hasTeammates:function(d){return!!this.clusters[d.cleanEmail]},teammates:function(d){const f=this.clusters[d.cleanEmail];return f?Array.from(f).sort():[]},scrollToEmail:function(d){const f=d.model.item;this.filtered.forEach((g,j)=>{g.cleanEmail===f&&this.$.list.scrollToIndex(j)})},acceptanceSent:function(d){return d.acceptance_sent&&'accepted'===d.status},rsvpLink:function(d){return'/rsvp/'+d.id+'#begin'},resetRSVPTime:function(d){const f=d.model.hacker;d.model.set('hacker.acceptance_sent.Time',moment().format()),this.patchHacker(f)},timeTo:function(d){return moment(d).add(7,'days').fromNow()}});