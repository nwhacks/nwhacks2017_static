!function(k,q){"function"==typeof define&&define.amd?define([],q):"object"==typeof module&&module.exports?module.exports=q():k.CSV=q()}(this,function(){"use strict";function k(Q){var R=typeof Q;return"function"==R||"object"==R&&!!Q}function q(Q){return"string"==typeof Q}function x(Q){return!isNaN(+Q)}function z(Q){return 0==Q||1==Q}function B(Q){return null==Q}function C(Q){return null!=Q}function E(Q,R){return C(Q)?Q:R}function F(Q,R){for(var S=0,T=Q.length;T>S&&!1!==R(Q[S],S);S+=1);}function G(Q){return Q.replace(/"/g,"\\\"")}function H(Q){return"attrs["+Q+"]"}function I(Q,R){return x(Q)?"Number("+H(R)+")":z(Q)?"Boolean("+H(R)+" == true)":"String("+H(R)+")"}function J(Q,R,S,T){var U=[];return 3==arguments.length?(R?O(R)?F(S,function(V,W){q(R[W])?R[W]=R[W].toLowerCase():Q[R[W]]=R[W],U.push("deserialize[cast["+W+"]]("+H(W)+")")}):F(S,function(V,W){U.push(I(V,W))}):F(S,function(V,W){U.push(H(W))}),U="return ["+U.join(",")+"]"):(R?O(R)?F(S,function(V,W){q(R[W])?R[W]=R[W].toLowerCase():Q[R[W]]=R[W],U.push("\""+G(T[W])+"\": deserialize[cast["+W+"]]("+H(W)+")")}):F(S,function(V,W){U.push("\""+G(T[W])+"\": "+I(V,W))}):F(S,function(V,W){U.push("\""+G(T[W])+"\": "+H(W))}),U="return {"+U.join(",")+"}"),Function("attrs","deserialize","cast",U)}function K(Q,R){var S,T=0;return F(R,function(U){var V,W=U;-1!=L.indexOf(U)&&(W="\\"+W),V=Q.match(RegExp(W,"g")),V&&V.length>T&&(T=V.length,S=U)}),S||R[0]}var L=["|","^"],M=[",",";","  ","|","^"],N=["\r\n","\r","\n"],O=Array.isArray||function(Q){return"[object Array]"===toString.call(Q)},P=function(){function Q(U,V){if(V||(V={}),O(U))this.mode="encode";else{if(!q(U))throw Error("Incompatible format!");this.mode="parse"}this.data=U,this.options={header:E(V.header,!1),cast:E(V.cast,!0)};var W=V.lineDelimiter||V.line,X=V.cellDelimiter||V.delimiter;this.isParser()?(this.options.lineDelimiter=W||K(this.data,N),this.options.cellDelimiter=X||K(this.data,M),this.data=S(this.data,this.options.lineDelimiter)):this.isEncoder()&&(this.options.lineDelimiter=W||"\r\n",this.options.cellDelimiter=X||",")}function R(U,V,W,X,Y){U(new V(W,X,Y))}function S(U,V){return U.slice(-V.length)!=V&&(U+=V),U}function T(U){return O(U)?"array":k(U)?"object":q(U)?"string":B(U)?"null":"primitive"}return Q.prototype.set=function(U,V){return this.options[U]=V},Q.prototype.isParser=function(){return"parse"==this.mode},Q.prototype.isEncoder=function(){return"encode"==this.mode},Q.prototype.parse=function(U){function V(){_={escaped:!1,quote:!1,cell:!0}}function W(){fa.cell=""}function X(){fa.line=[]}function Y(na){fa.line.push(_.escaped?na.slice(1,-1).replace(/""/g,"\""):na),W(),V()}function Z(na){Y(na.slice(0,1-da.lineDelimiter.length))}function $(){ea?O(ea)?(aa=J(ga,da.cast,fa.line,ea),($=function(){R(U,aa,fa.line,ga,da.cast)})()):ea=fa.line:(aa||(aa=J(ga,da.cast,fa.line)),($=function(){R(U,aa,fa.line,ga,da.cast)})())}if("parse"==this.mode){if(0===this.data.trim().length)return[];var _,aa,ba,ca=this.data,da=this.options,ea=da.header,fa={cell:"",line:[]},ga=this.deserialize;U||(ba=[],U=function(na){ba.push(na)}),1==da.lineDelimiter.length&&(Z=Y);var ha,ia,ja,ka=ca.length,la=da.cellDelimiter.charCodeAt(0),ma=da.lineDelimiter.charCodeAt(da.lineDelimiter.length-1);for(V(),ha=0,ia=0;ka>ha;ha++)ja=ca.charCodeAt(ha),_.cell&&(_.cell=!1,34==ja)?_.escaped=!0:_.escaped&&34==ja?_.quote=!_.quote:(_.escaped&&_.quote||!_.escaped)&&(ja==la?(Y(fa.cell+ca.slice(ia,ha)),ia=ha+1):ja==ma&&(Z(fa.cell+ca.slice(ia,ha)),ia=ha+1,(1<fa.line.length||""!==fa.line[0])&&$(),X()));return ba?ba:this}},Q.prototype.deserialize={string:function(U){return U+""},number:function(U){return+U},boolean:function(U){return!!U}},Q.prototype.serialize={object:function(U){var V=this,W=Object.keys(U),X=Array(W.length);return F(W,function(Y,Z){X[Z]=V[T(U[Y])](U[Y])}),X},array:function(U){var V=this,W=Array(U.length);return F(U,function(X,Y){W[Y]=V[T(X)](X)}),W},string:function(U){return"\""+(U+"").replace(/"/g,"\"\"")+"\""},"null":function(){return""},primitive:function(U){return U}},Q.prototype.encode=function(U){function V(ea){return ea.join(Z.cellDelimiter)}if("encode"==this.mode){if(0==this.data.length)return"";var W,X,Y=this.data,Z=this.options,$=Z.header,_=Y[0],aa=this.serialize,ba=0;U||(X=Array(Y.length),U=function(ea,fa){X[fa+ba]=ea}),$&&(O($)||(W=Object.keys(_),$=W),U(V(aa.array($)),0),ba=1);var ca,da=T(_);return"array"==da?(O(Z.cast)?(ca=Array(Z.cast.length),F(Z.cast,function(ea,fa){q(ea)?ca[fa]=ea.toLowerCase():(ca[fa]=ea,aa[ea]=ea)})):(ca=Array(_.length),F(_,function(ea,fa){ca[fa]=T(ea)})),F(Y,function(ea,fa){var ga=Array(ca.length);F(ea,function(ha,ia){ga[ia]=aa[ca[ia]](ha)}),U(V(ga),fa)})):"object"==da&&(W=Object.keys(_),O(Z.cast)?(ca=Array(Z.cast.length),F(Z.cast,function(ea,fa){q(ea)?ca[fa]=ea.toLowerCase():(ca[fa]=ea,aa[ea]=ea)})):(ca=Array(W.length),F(W,function(ea,fa){ca[fa]=T(_[ea])})),F(Y,function(ea,fa){var ga=Array(W.length);F(W,function(ha,ia){ga[ia]=aa[ca[ia]](ea[ha])}),U(V(ga),fa)})),X?X.join(Z.lineDelimiter):this}},Q.prototype.forEach=function(U){return this[this.mode](U)},Q}();return P.parse=function(Q,R){return new P(Q,R).parse()},P.encode=function(Q,R){return new P(Q,R).encode()},P.forEach=function(Q,R,S){return 2==arguments.length&&(S=R),new P(Q,R).forEach(S)},P});